import{Fragment as G,computed as g,defineComponent as A,h as _,inject as Q,nextTick as E,onMounted as q,onUnmounted as X,provide as Y,ref as w,toRaw as f,watch as J,watchEffect as K}from"vue";import{Features as N,render as F,omit as $,compact as Z}from'../../utils/render.js';import{useId as j}from'../../hooks/use-id.js';import{Keys as I}from'../../keyboard.js';import{calculateActiveIndex as z,Focus as T}from'../../utils/calculate-active-index.js';import{dom as P}from'../../utils/dom.js';import{useOpenClosed as ee,State as U,useOpenClosedProvider as te}from'../../internal/open-closed.js';import{match as M}from'../../utils/match.js';import{useResolveButtonType as oe}from'../../hooks/use-resolve-button-type.js';import{useTreeWalker as ne}from'../../hooks/use-tree-walker.js';import{sortByDomNode as ae}from'../../utils/focus-management.js';import{useOutsideClick as le}from'../../hooks/use-outside-click.js';import{Hidden as ie,Features as ue}from'../../internal/hidden.js';import{objectToFormEntries as re}from'../../utils/form.js';import{useControllable as se}from'../../hooks/use-controllable.js';function de(n,x){return n===x}var pe=(l=>(l[l.Open=0]="Open",l[l.Closed=1]="Closed",l))(pe||{}),be=(l=>(l[l.Single=0]="Single",l[l.Multi=1]="Multi",l))(be||{}),fe=(l=>(l[l.Pointer=0]="Pointer",l[l.Other=1]="Other",l))(fe||{});let W=Symbol("ComboboxContext");function L(n){let x=Q(W,null);if(x===null){let l=new Error(`<${n} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(l,L),l}return x}let Ae=A({name:"Combobox",emits:{"update:modelValue":n=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>de},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},name:{type:String},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(n,{slots:x,attrs:l,emit:y}){let e=w(1),t=w(null),v=w(null),S=w(null),C=w(null),m=w({static:!1,hold:!1}),a=w([]),O=w(null),o=w(1),b=w(!1);function d(i=s=>s){let s=O.value!==null?a.value[O.value]:null,r=ae(i(a.value.slice()),c=>P(c.dataRef.domRef)),u=s?r.indexOf(s):null;return u===-1&&(u=null),{options:r,activeOptionIndex:u}}let R=g(()=>n.multiple?1:0),D=g(()=>n.nullable),[k,V]=se(g(()=>n.modelValue),i=>y("update:modelValue",i),g(()=>n.defaultValue)),p={comboboxState:e,value:k,mode:R,compare(i,s){if(typeof n.by=="string"){let r=n.by;return(i==null?void 0:i[r])===(s==null?void 0:s[r])}return n.by(i,s)},nullable:D,inputRef:v,labelRef:t,buttonRef:S,optionsRef:C,disabled:g(()=>n.disabled),options:a,change(i){V(i)},activeOptionIndex:g(()=>{if(b.value&&O.value===null&&a.value.length>0){let i=a.value.findIndex(s=>!s.dataRef.disabled);if(i!==-1)return i}return O.value}),activationTrigger:o,optionsPropsRef:m,closeCombobox(){b.value=!1,!n.disabled&&e.value!==1&&(e.value=1,O.value=null)},openCombobox(){if(b.value=!0,n.disabled||e.value===0)return;let i=a.value.findIndex(s=>{let r=f(s.dataRef.value);return M(R.value,{[0]:()=>p.compare(f(p.value.value),f(r)),[1]:()=>f(p.value.value).some(c=>p.compare(f(c),f(r)))})});i!==-1&&(O.value=i),e.value=0},goToOption(i,s,r){if(b.value=!1,n.disabled||C.value&&!m.value.static&&e.value===1)return;let u=d();if(u.activeOptionIndex===null){let h=u.options.findIndex(B=>!B.dataRef.disabled);h!==-1&&(u.activeOptionIndex=h)}let c=z(i===T.Specific?{focus:T.Specific,id:s}:{focus:i},{resolveItems:()=>u.options,resolveActiveIndex:()=>u.activeOptionIndex,resolveId:h=>h.id,resolveDisabled:h=>h.dataRef.disabled});O.value=c,o.value=r!=null?r:1,a.value=u.options},selectOption(i){let s=a.value.find(u=>u.id===i);if(!s)return;let{dataRef:r}=s;V(M(R.value,{[0]:()=>r.value,[1]:()=>{let u=f(p.value.value).slice(),c=f(r.value),h=u.findIndex(B=>p.compare(c,f(B)));return h===-1?u.push(c):u.splice(h,1),u}}))},selectActiveOption(){if(p.activeOptionIndex.value===null)return;let{dataRef:i,id:s}=a.value[p.activeOptionIndex.value];V(M(R.value,{[0]:()=>i.value,[1]:()=>{let r=f(p.value.value).slice(),u=f(i.value),c=r.findIndex(h=>p.compare(u,f(h)));return c===-1?r.push(u):r.splice(c,1),r}})),p.goToOption(T.Specific,s)},registerOption(i,s){let r={id:i,dataRef:s},u=d(c=>[...c,r]);if(O.value===null){let c=s.value.value;M(R.value,{[0]:()=>p.compare(f(p.value.value),f(c)),[1]:()=>f(p.value.value).some(B=>p.compare(f(B),f(c)))})&&(u.activeOptionIndex=u.options.indexOf(r))}a.value=u.options,O.value=u.activeOptionIndex,o.value=1},unregisterOption(i){let s=d(r=>{let u=r.findIndex(c=>c.id===i);return u!==-1&&r.splice(u,1),r});a.value=s.options,O.value=s.activeOptionIndex,o.value=1}};le([v,S,C],()=>p.closeCombobox(),g(()=>e.value===0)),Y(W,p),te(g(()=>M(e.value,{[0]:U.Open,[1]:U.Closed})));let H=g(()=>p.activeOptionIndex.value===null?null:a.value[p.activeOptionIndex.value].dataRef.value);return()=>{let{name:i,disabled:s,...r}=n,u={open:e.value===0,disabled:s,activeIndex:p.activeOptionIndex.value,activeOption:H.value,value:k.value};return _(G,[...i!=null&&k.value!=null?re({[i]:k.value}).map(([c,h])=>_(ie,Z({features:ue.Hidden,key:c,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:c,value:h}))):[],F({theirProps:{...l,...$(r,["modelValue","defaultValue","nullable","multiple","onUpdate:modelValue","by"])},ourProps:{},slot:u,slots:x,attrs:l,name:"Combobox"})])}}}),Fe=A({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"}},setup(n,{attrs:x,slots:l}){let y=L("ComboboxLabel"),e=`headlessui-combobox-label-${j()}`;function t(){var v;(v=P(y.inputRef))==null||v.focus({preventScroll:!0})}return()=>{let v={open:y.comboboxState.value===0,disabled:y.disabled.value},S={id:e,ref:y.labelRef,onClick:t};return F({ourProps:S,theirProps:n,slot:v,attrs:x,slots:l,name:"ComboboxLabel"})}}}),Le=A({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"}},setup(n,{attrs:x,slots:l,expose:y}){let e=L("ComboboxButton"),t=`headlessui-combobox-button-${j()}`;y({el:e.buttonRef,$el:e.buttonRef});function v(m){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(m.preventDefault(),e.openCombobox()),E(()=>{var a;return(a=P(e.inputRef))==null?void 0:a.focus({preventScroll:!0})}))}function S(m){switch(m.key){case I.ArrowDown:m.preventDefault(),m.stopPropagation(),e.comboboxState.value===1&&e.openCombobox(),E(()=>{var a;return(a=e.inputRef.value)==null?void 0:a.focus({preventScroll:!0})});return;case I.ArrowUp:m.preventDefault(),m.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),E(()=>{e.value.value||e.goToOption(T.Last)})),E(()=>{var a;return(a=e.inputRef.value)==null?void 0:a.focus({preventScroll:!0})});return;case I.Escape:if(e.comboboxState.value!==0)return;m.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&m.stopPropagation(),e.closeCombobox(),E(()=>{var a;return(a=e.inputRef.value)==null?void 0:a.focus({preventScroll:!0})});return}}let C=oe(g(()=>({as:n.as,type:x.type})),e.buttonRef);return()=>{var o,b;let m={open:e.comboboxState.value===0,disabled:e.disabled.value,value:e.value.value},a={ref:e.buttonRef,id:t,type:C.value,tabindex:"-1","aria-haspopup":!0,"aria-controls":(o=P(e.optionsRef))==null?void 0:o.id,"aria-expanded":e.disabled.value?void 0:e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(b=P(e.labelRef))==null?void 0:b.id,t].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:S,onClick:v};return F({ourProps:a,theirProps:n,slot:m,attrs:x,slots:l,name:"ComboboxButton"})}}}),Be=A({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function}},emits:{change:n=>!0},setup(n,{emit:x,attrs:l,slots:y,expose:e}){let t=L("ComboboxInput"),v=`headlessui-combobox-input-${j()}`;e({el:t.inputRef,$el:t.inputRef});let S=w(t.value.value),C=()=>{var b;let o=t.value.value;return P(t.inputRef)?typeof n.displayValue!="undefined"?(b=n.displayValue(o))!=null?b:"":typeof o=="string"?o:"":""};q(()=>{J([t.value],()=>S.value=C(),{flush:"sync",immediate:!0}),J([S,t.comboboxState],([o,b],[d,R])=>{let D=P(t.inputRef);!D||(R===0&&b===1||o!==d)&&(D.value=o)},{immediate:!0})});function m(o){switch(o.key){case I.Backspace:case I.Delete:if(t.mode.value!==0||!t.nullable.value)return;let b=o.currentTarget;requestAnimationFrame(()=>{if(b.value===""){t.change(null);let d=P(t.optionsRef);d&&(d.scrollTop=0),t.goToOption(T.Nothing)}});break;case I.Enter:if(t.comboboxState.value!==0||o.isComposing)return;if(o.preventDefault(),o.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case I.ArrowDown:return o.preventDefault(),o.stopPropagation(),M(t.comboboxState.value,{[0]:()=>t.goToOption(T.Next),[1]:()=>t.openCombobox()});case I.ArrowUp:return o.preventDefault(),o.stopPropagation(),M(t.comboboxState.value,{[0]:()=>t.goToOption(T.Previous),[1]:()=>{t.openCombobox(),E(()=>{t.value.value||t.goToOption(T.Last)})}});case I.Home:case I.PageUp:return o.preventDefault(),o.stopPropagation(),t.goToOption(T.First);case I.End:case I.PageDown:return o.preventDefault(),o.stopPropagation(),t.goToOption(T.Last);case I.Escape:if(t.comboboxState.value!==0)return;o.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&o.stopPropagation(),t.closeCombobox();break;case I.Tab:if(t.comboboxState.value!==0)return;t.mode.value===0&&t.selectActiveOption(),t.closeCombobox();break}}function a(o){x("change",o)}function O(o){t.openCombobox(),x("change",o)}return()=>{var R,D,k,V,p,H;let o={open:t.comboboxState.value===0},b={"aria-controls":(R=t.optionsRef.value)==null?void 0:R.id,"aria-expanded":t.disabled.value?void 0:t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||(D=t.options.value[t.activeOptionIndex.value])==null?void 0:D.id,"aria-multiselectable":t.mode.value===1?!0:void 0,"aria-labelledby":(p=(k=P(t.labelRef))==null?void 0:k.id)!=null?p:(V=P(t.buttonRef))==null?void 0:V.id,id:v,onKeydown:m,onChange:a,onInput:O,role:"combobox",type:(H=l.type)!=null?H:"text",tabIndex:0,ref:t.inputRef},d=$(n,["displayValue"]);return F({ourProps:b,theirProps:d,slot:o,attrs:l,slots:y,features:N.RenderStrategy|N.Static,name:"ComboboxInput"})}}}),je=A({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(n,{attrs:x,slots:l,expose:y}){let e=L("ComboboxOptions"),t=`headlessui-combobox-options-${j()}`;y({el:e.optionsRef,$el:e.optionsRef}),K(()=>{e.optionsPropsRef.value.static=n.static}),K(()=>{e.optionsPropsRef.value.hold=n.hold});let v=ee(),S=g(()=>v!==null?v.value===U.Open:e.comboboxState.value===0);return ne({container:g(()=>P(e.optionsRef)),enabled:g(()=>e.comboboxState.value===0),accept(C){return C.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:C.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(C){C.setAttribute("role","none")}}),()=>{var O,o,b,d;let C={open:e.comboboxState.value===0},m={"aria-activedescendant":e.activeOptionIndex.value===null||(O=e.options.value[e.activeOptionIndex.value])==null?void 0:O.id,"aria-labelledby":(d=(o=P(e.labelRef))==null?void 0:o.id)!=null?d:(b=P(e.buttonRef))==null?void 0:b.id,id:t,ref:e.optionsRef,role:"listbox"},a=$(n,["hold"]);return F({ourProps:m,theirProps:a,slot:C,attrs:x,slots:l,features:N.RenderStrategy|N.Static,visible:S.value,name:"ComboboxOptions"})}}}),He=A({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(n,{slots:x,attrs:l,expose:y}){let e=L("ComboboxOption"),t=`headlessui-combobox-option-${j()}`,v=w(null);y({el:v,$el:v});let S=g(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),C=g(()=>M(e.mode.value,{[0]:()=>e.compare(f(e.value.value),f(n.value)),[1]:()=>f(e.value.value).some(d=>e.compare(f(d),f(n.value)))})),m=g(()=>({disabled:n.disabled,value:n.value,domRef:v}));q(()=>e.registerOption(t,m)),X(()=>e.unregisterOption(t)),K(()=>{e.comboboxState.value===0&&(!S.value||e.activationTrigger.value!==0&&E(()=>{var d,R;return(R=(d=P(v))==null?void 0:d.scrollIntoView)==null?void 0:R.call(d,{block:"nearest"})}))});function a(d){if(n.disabled)return d.preventDefault();e.selectOption(t),e.mode.value===0&&e.closeCombobox()}function O(){if(n.disabled)return e.goToOption(T.Nothing);e.goToOption(T.Specific,t)}function o(){n.disabled||S.value||e.goToOption(T.Specific,t,0)}function b(){n.disabled||!S.value||e.optionsPropsRef.value.hold||e.goToOption(T.Nothing)}return()=>{let{disabled:d}=n,R={active:S.value,selected:C.value,disabled:d},D={id:t,ref:v,role:"option",tabIndex:d===!0?void 0:-1,"aria-disabled":d===!0?!0:void 0,"aria-selected":C.value,disabled:void 0,onClick:a,onFocus:O,onPointermove:o,onMousemove:o,onPointerleave:b,onMouseleave:b};return F({ourProps:D,theirProps:n,slot:R,attrs:l,slots:x,name:"ComboboxOption"})}}});export{Ae as Combobox,Le as ComboboxButton,Be as ComboboxInput,Fe as ComboboxLabel,He as ComboboxOption,je as ComboboxOptions};
